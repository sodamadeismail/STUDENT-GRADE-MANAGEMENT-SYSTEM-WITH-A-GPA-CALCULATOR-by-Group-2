<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Student Portal</title>
    <style>
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 20px; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary mb-4 no-print">
        <div class="container"><span class="navbar-brand">SIRMS Student</span><a href="/logout" class="btn btn-light btn-sm">Logout</a></div>
    </nav>
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4 mb-4 shadow-sm">
                    <h4>{{ data.name }}</h4>
                    <p class="text-muted small">{{ data.dept }} | {{ session['user'] }}</p>
                    <div class="alert alert-primary text-center">
                        <small>Cumulative CGPA</small><h2 class="mb-0">{{ cgpa }}</h2>
                    </div>
                    <div class="chart-container"><canvas id="gpaChart"></canvas></div>
                    <button class="btn btn-dark w-100 no-print" onclick="window.print()">Print Statement</button>
                </div>
            </div>
            <div class="col-md-8">
                {% for level, courses in data.results.items() %}
                <div class="card p-4 mb-3 shadow-sm">
                    <div class="d-flex justify-content-between border-bottom mb-3">
                        <h5 class="text-primary">{{ level }} Results</h5>
                        {% set l_p = namespace(v=0) %}{% set l_u = namespace(v=0) %}
                        {% for c in courses %}{% set l_p.v = l_p.v + (c.units * c.point) %}{% set l_u.v = l_u.v + c.units %}{% endfor %}
                        <span class="badge bg-secondary">GPA: {{ (l_p.v / l_u.v)|round(2) if l_u.v > 0 else '0.0' }}</span>
                    </div>
                    <table class="table table-hover">
                        <thead><tr><th>Course</th><th>Score</th><th>Grade</th><th>Units</th></tr></thead>
                        <tbody>
                            {% for c in courses %}
                            <tr><td>{{ c.course }}</td><td>{{ c.score }}%</td><td class="fw-bold">{{ c.grade }}</td><td>{{ c.units }}</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <script>
        const ctx = document.getElementById('gpaChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: JSON.parse('{{ levels|tojson }}'),
                datasets: [{
                    label: 'GPA',
                    data: JSON.parse('{{ level_gpas|tojson }}'),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 5 } } }
        });
    </script>
</body>
</html>